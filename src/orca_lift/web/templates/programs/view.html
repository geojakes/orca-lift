{% extends "base.html" %}

{% block title %}{{ program.name }} - orca-lift{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-start mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">{{ program.name }}</h1>
            <p class="text-gray-600 mt-1">{{ program.description }}</p>
        </div>
        <div class="flex space-x-2">
            <button onclick="copyLiftoscript()"
                    class="bg-gray-100 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-200 transition">
                Export Liftoscript
            </button>
            <a href="/progress/{{ program.id }}"
               class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition">
                Track Progress
            </a>
        </div>
    </div>

    <!-- Program Structure -->
    <div class="bg-white shadow rounded-lg overflow-hidden mb-6">
        <div class="px-6 py-4 border-b bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-900">Program Structure</h2>
            <p class="text-sm text-gray-500">
                {{ program.total_weeks }} weeks, {{ program.days_per_week }} days/week
            </p>
        </div>

        <div class="divide-y">
            {% for week in program.weeks %}
            <details class="group" {% if loop.first %}open{% endif %}>
                <summary class="px-6 py-4 cursor-pointer hover:bg-gray-50 flex justify-between items-center">
                    <span class="font-medium text-gray-900">
                        Week {{ week.week_number }}
                        {% if week.deload %}
                        <span class="ml-2 text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded">Deload</span>
                        {% endif %}
                    </span>
                    <svg class="w-5 h-5 text-gray-400 group-open:rotate-180 transition-transform"
                         fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </summary>
                <div class="px-6 pb-4 space-y-4">
                    {% for day in week.days %}
                    <div class="border rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="font-medium text-gray-900">
                                Day {{ loop.index }} - {{ day.name }}
                                {% if day.focus %}
                                <span class="text-gray-500 font-normal">| {{ day.focus }}</span>
                                {% endif %}
                            </h3>
                            {% if progress and progress.current_week == week.week_number and progress.current_day == loop.index %}
                            <span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded">Current</span>
                            {% endif %}
                        </div>
                        <div class="space-y-2">
                            {% for exercise in day.exercises %}
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-700">{{ exercise.name }}</span>
                                <span class="text-gray-500">
                                    {{ exercise.sets|length }}x{{ exercise.sets[0].reps if exercise.sets else '?' }}
                                    | {{ exercise.progression.value }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </details>
            {% endfor %}
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="bg-white shadow rounded-lg overflow-hidden">
        <div class="px-6 py-4 border-b bg-gray-50">
            <h2 class="text-lg font-semibold text-gray-900">Chat with Coaches</h2>
            <p class="text-sm text-gray-500">Ask for modifications to your program</p>
        </div>

        <div id="chat-messages" class="p-6 space-y-4 max-h-96 overflow-y-auto">
            <p class="text-gray-500 text-center text-sm">
                Type a message to refine your program. Try "Add more tricep work" or "Make week 4 a deload".
            </p>
        </div>

        <div class="px-6 py-4 border-t bg-gray-50">
            <form id="chat-form" class="flex space-x-2">
                <input type="text" id="chat-input"
                       placeholder="Type your request..."
                       class="flex-1 border rounded-lg px-3 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                <button type="submit"
                        class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition">
                    Send
                </button>
            </form>
        </div>
    </div>
</div>

<script>
const programId = {{ program.id }};

async function copyLiftoscript() {
    try {
        const response = await fetch(`/programs/${programId}/liftoscript`);
        const data = await response.json();
        await navigator.clipboard.writeText(data.liftoscript);
        alert('Liftoscript copied to clipboard! Paste it into Liftosaur planner.');
    } catch (err) {
        alert('Failed to copy: ' + err.message);
    }
}

document.getElementById('chat-form')?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const input = document.getElementById('chat-input');
    const messages = document.getElementById('chat-messages');
    const message = input.value.trim();

    if (!message) return;

    // Add user message
    const userMsg = document.createElement('div');
    userMsg.className = 'flex justify-end';
    userMsg.innerHTML = `
        <div class="bg-indigo-600 text-white rounded-lg px-4 py-2 max-w-md">
            ${message}
        </div>
    `;
    messages.appendChild(userMsg);
    input.value = '';
    messages.scrollTop = messages.scrollHeight;

    // Add loading indicator
    const loadingMsg = document.createElement('div');
    loadingMsg.className = 'flex justify-start';
    loadingMsg.id = 'loading-message';
    loadingMsg.innerHTML = `
        <div class="bg-gray-100 text-gray-700 rounded-lg px-4 py-2">
            <div class="animate-pulse flex space-x-2 items-center">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
        </div>
    `;
    messages.appendChild(loadingMsg);
    messages.scrollTop = messages.scrollHeight;

    const formData = new FormData();
    formData.append('message', message);

    try {
        const response = await fetch(`/programs/${programId}/chat`, {
            method: 'POST',
            body: formData,
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;

            const text = decoder.decode(value);
            const lines = text.split('\n');

            for (const line of lines) {
                if (line.startsWith('data: ')) {
                    try {
                        const data = JSON.parse(line.slice(6));

                        if (data.type === 'complete') {
                            document.getElementById('loading-message')?.remove();

                            const botMsg = document.createElement('div');
                            botMsg.className = 'flex justify-start';
                            botMsg.innerHTML = `
                                <div class="bg-green-100 text-green-800 rounded-lg px-4 py-2 max-w-md">
                                    <p class="font-medium">Program updated!</p>
                                    <p class="text-sm mt-1">Refresh the page to see changes.</p>
                                </div>
                            `;
                            messages.appendChild(botMsg);
                            messages.scrollTop = messages.scrollHeight;
                        } else if (data.type === 'error') {
                            document.getElementById('loading-message')?.remove();

                            const errorMsg = document.createElement('div');
                            errorMsg.className = 'flex justify-start';
                            errorMsg.innerHTML = `
                                <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 max-w-md">
                                    Error: ${data.message}
                                </div>
                            `;
                            messages.appendChild(errorMsg);
                            messages.scrollTop = messages.scrollHeight;
                        }
                    } catch (parseError) {
                        // Skip invalid JSON
                    }
                }
            }
        }
    } catch (err) {
        document.getElementById('loading-message')?.remove();

        const errorMsg = document.createElement('div');
        errorMsg.className = 'flex justify-start';
        errorMsg.innerHTML = `
            <div class="bg-red-100 text-red-800 rounded-lg px-4 py-2 max-w-md">
                Error: ${err.message}
            </div>
        `;
        messages.appendChild(errorMsg);
        messages.scrollTop = messages.scrollHeight;
    }
});
</script>
{% endblock %}
